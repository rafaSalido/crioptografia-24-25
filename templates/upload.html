<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Upload Website</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100">
    <header class="bg-blue-600 text-white p-4">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">File Upload Website</h1>
            <div class="flex items-center">
                <span class="mr-4">Welcome, {{ username }}!</span>
                <a href="{{ url_for('logout') }}" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                    Logout
                </a>
            </div>
        </div>
    </header>

    <section class="bg-blue-500 text-white py-20">
        <div class="container mx-auto text-center">
            <h2 class="text-4xl font-bold mb-4">Welcome to Our File Upload Service</h2>
            <p class="text-xl">Easily manage and upload your files with our intuitive interface.</p>
        </div>
    </section>

    <main class="container mx-auto mt-8 p-4">
        <div class="flex flex-col md:flex-row gap-8">
            <div class="w-full md:w-1/2 bg-white p-6 rounded-lg shadow">
                <h3  class="text-xl font-semibold mb-4">Files to Upload</h3>
                <ul class="space-y-2" id="fileList">
                    <li class="text-gray-600">No files selected yet.</li>
                </ul>
                <div class="mt-4 space-y-4" id="uploadControls" style="display: none;">
                    <input type="password" id="passwordInput" 
                           class="w-full p-2 border rounded" 
                           placeholder="Enter password (minimum 5 characters)">
                    <button onclick="uploadFiles()" 
                            class="w-full bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                        Encrypt and Upload
                    </button>
                </div>
            </div>
            <div class="w-full md:w-1/2 bg-white p-6 rounded-lg shadow">
                <h3 class="text-xl font-semibold mb-4">Upload Files</h3>
                <div class="border-dashed border-2 border-gray-300 p-8 text-center rounded-lg mb-4" id="dropZone">
                    <p>Drag and drop files here</p>
                    <p class="text-sm text-gray-500 mt-2">or</p>
                </div>
                <div class="text-center">
                    <label for="fileInput"
                        class="bg-blue-500 text-white px-4 py-2 rounded cursor-pointer hover:bg-blue-600">
                        Select Files
                    </label>
                    <input type="file" id="fileInput" class="hidden">
                </div>
            </div>
        </div>
        <div class="mt-8 bg-white p-6 rounded-lg shadow">
            <h3 class="text-xl font-semibold mb-4">Encrypted Files</h3>
            <ul id="encryptedFileList" class="space-y-2">
                <li class="text-gray-600">Loading...</li>
            </ul>
        </div>
    </main>

    <script>
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const uploadControls = document.getElementById('uploadControls');
        const encryptedFileList = document.getElementById('encryptedFileList');
        let selectedFiles = [];

        // Prevent default drag behaviors
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });

        // Highlight drop zone when item is dragged over it
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });

        // Handle dropped files
        dropZone.addEventListener('drop', handleDrop, false);

        // Handle selected files
        fileInput.addEventListener('change', handleFiles, false);

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function highlight() {
            dropZone.classList.add('bg-blue-100');
        }

        function unhighlight() {
            dropZone.classList.remove('bg-blue-100');
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        function handleFiles(files) {
            selectedFiles = Array.from(files);
            updateFileList();
            uploadControls.style.display = 'block';
        }

        function updateFileList() {
            fileList.innerHTML = selectedFiles.map(file => `<li class="text-gray-800">${file.name}</li>`).join('');
        }

        async function uploadFiles() {
            const password = document.getElementById('passwordInput').value;
            
            if (password.length < 5) {
                alert('Password must be at least 5 characters long');
                return;
            }

            if (selectedFiles.length === 0) {
                alert('Please select a file first');
                return;
            }

            for (const file of selectedFiles) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('password', password);

                try {
                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const result = await response.json();
                        alert(result.message);
                    } else {
                        const error = await response.json();
                        alert(error.error || 'Upload failed');
                    }
                } catch (error) {
                    alert('Error uploading file: ' + error.message);
                }
            }

            // Clear the form
            selectedFiles = [];
            fileInput.value = '';
            document.getElementById('passwordInput').value = '';
            updateFileList();
            uploadControls.style.display = 'none';
            
            // Refresh the encrypted file list
            fetchEncryptedFiles();
        }

        async function fetchEncryptedFiles() {
            try {
                const response = await fetch('/files');
                const files = await response.json();
                encryptedFileList.innerHTML = '';

                 // Check if no files are returned
                if (files.length === 0) {
                    encryptedFileList.innerHTML = '<li class="text-gray-600">No files saved yet.</li>';
                    return;  // Exit function since there are no files
                }
                files.forEach(file => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center p-2 bg-gray-50 rounded';
                    li.innerHTML = `
                        <span>${file.original_name}</span>
                        <button onclick="downloadFile('${file.encrypted_name}')" class="bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600">
                            Download
                        </button>
                    `;
                    encryptedFileList.appendChild(li);
                });
               
            } catch (error) {
                console.error('Error fetching encrypted files:', error);
                encryptedFileList.innerHTML = '<li class="text-red-600">Error loading encrypted files.</li>';
            }
        }

        async function downloadFile(filename) {
            const password = prompt('Enter the password to decrypt the file:');
            if (!password) return;

            try {
                const response = await fetch(`/download/${filename}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ password }),
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = filename.replace('_encrypted', '_decrypted');
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                } else {
                    const error = await response.json();
                    alert(error.error || 'Download failed');
                }
            } catch (error) {
                alert('Error downloading file: ' + error.message);
            }
        }

        // Fetch encrypted files on page load
        fetchEncryptedFiles();
    </script>
</body>

</html>